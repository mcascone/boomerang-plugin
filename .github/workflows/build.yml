name: Build

on:
  push:
    branches: ['**']
    paths-ignore:
      - '*.md'
      - '.github/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            cmake_flags: -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DCMAKE_OSX_DEPLOYMENT_TARGET=10.13
            artifact_name: boomerang-macos
          - os: windows-latest
            cmake_flags: ""
            artifact_name: boomerang-windows
          - os: ubuntu-latest
            cmake_flags: ""
            artifact_name: boomerang-linux

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0  # Full history for git version

      # Extract version from git (single source of truth)
      - name: Extract Version
        id: version
        shell: bash
        run: |
          # Use git describe for version
          # At a tag:    v2.0.0-beta-3 -> 2.0.0-beta-3
          # After a tag: v2.0.0-beta-3-5-g1234abc -> 2.0.0-beta-3+5.g1234abc
          GIT_DESCRIBE=$(git describe --tags --always)
          # Strip 'v' prefix
          VERSION="${GIT_DESCRIBE#v}"
          # Convert git format (tag-N-gHASH) to semver metadata (tag+N.gHASH)
          VERSION=$(echo "$VERSION" | sed -E 's/^(.+)-([0-9]+)-(g[0-9a-f]+)$/\1+\2.\3/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      # Linux: Install ALSA and other audio dependencies
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libjack-jackd2-dev \
            ladspa-sdk \
            libfreetype6-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxrender-dev \
            libwebkit2gtk-4.1-dev \
            libglu1-mesa-dev \
            mesa-common-dev

      # Configure CMake
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ${{ matrix.cmake_flags }}

      # Build
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      # List build artifacts for debugging
      - name: List Artifacts
        shell: bash
        run: |
          echo "=== Build Artifacts ==="
          find build -name "*.vst3" -o -name "*.component" -o -name "*.app" -o -name "*.exe" 2>/dev/null || true
          ls -la build/Boomerang_artefacts/ || true

      # Import signing certificates (macOS only)
      - name: Import Signing Certificates
        if: runner.os == 'macOS'
        env:
          MACOS_INSTALLER_CERT: ${{ secrets.MACOS_INSTALLER_CERT }}
          MACOS_INSTALLER_CERT_PWD: ${{ secrets.MACOS_INSTALLER_CERT_PWD }}
          MACOS_APPLICATION_CERT: ${{ secrets.MACOS_APPLICATION_CERT }}
          MACOS_APPLICATION_CERT_PWD: ${{ secrets.MACOS_APPLICATION_CERT_PWD }}
        run: |
          # Skip if no certificates configured
          if [ -z "$MACOS_INSTALLER_CERT" ]; then
            echo "::warning::No signing certificates configured — installer will not be signed or notarized"
            exit 0
          fi
          
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PWD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          
          # Import Developer ID Installer certificate
          echo "$MACOS_INSTALLER_CERT" | base64 --decode > $RUNNER_TEMP/installer_cert.p12
          if ! security import $RUNNER_TEMP/installer_cert.p12 -k "$KEYCHAIN_PATH" \
            -P "$MACOS_INSTALLER_CERT_PWD" -T /usr/bin/productsign -T /usr/bin/pkgbuild -T /usr/bin/productbuild; then
            echo "::warning::Failed to import Installer certificate"
            exit 0
          fi
          
          # Import Developer ID Application certificate
          echo "$MACOS_APPLICATION_CERT" | base64 --decode > $RUNNER_TEMP/app_cert.p12
          if ! security import $RUNNER_TEMP/app_cert.p12 -k "$KEYCHAIN_PATH" \
            -P "$MACOS_APPLICATION_CERT_PWD" -T /usr/bin/codesign; then
            echo "::warning::Failed to import Application certificate"
            exit 0
          fi
          
          # Set keychain for signing
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          
          echo "✓ Certificates imported"

      # Package - macOS
      - name: Package macOS
        if: runner.os == 'macOS'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist
          # Create zip with all formats (artifacts are in BUILD_TYPE/ for multi-config builds)
          cd build/Boomerang_artefacts/${{ env.BUILD_TYPE }}
          cp ../../../README.md .
          zip -r ../../../dist/Boomerang-${VERSION}-macOS.zip VST3 AU Standalone README.md
          cd ../../..
          # Build the installer package
          BOOMERANG_VERSION="$VERSION" ./build-installer.sh
          cp build/installer/*.pkg dist/ 2>/dev/null || true

      # Package - Windows
      - name: Package Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist
          cd build/Boomerang_artefacts/Release
          cp ../../../README.md .
          7z a ../../../dist/Boomerang-${VERSION}-Windows.zip VST3 Standalone README.md
          cd ../../..

      # Package - Linux
      - name: Package Linux
        if: runner.os == 'Linux'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist
          cd build/Boomerang_artefacts/Release
          cp ../../../README.md .
          tar -czvf ../../../dist/Boomerang-${VERSION}-Linux.tar.gz VST3 Standalone README.md
          cd ../../..

      # Upload artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/*
          retention-days: 14

  # Validate plugins with pluginval (downloads artifacts from build job - no rebuild)
  validate:
    name: Validate ${{ matrix.os }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            pluginval_url: https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_macOS.zip
            artifact_name: boomerang-macos
            archive_pattern: "Boomerang-*-macOS.zip"
          - os: windows-latest
            pluginval_url: https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_Windows.zip
            artifact_name: boomerang-windows
            archive_pattern: "Boomerang-*-Windows.zip"
          - os: ubuntu-latest
            pluginval_url: https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_Linux.zip
            artifact_name: boomerang-linux
            archive_pattern: "Boomerang-*-Linux.tar.gz"

    runs-on: ${{ matrix.os }}

    steps:
      # Download build artifacts (no checkout/rebuild needed)
      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: dist

      # Find the archive file (name includes version)
      - name: Find Archive
        id: find_archive
        shell: bash
        run: |
          cd dist
          ARCHIVE=$(ls ${{ matrix.archive_pattern }} 2>/dev/null | head -1)
          if [ -z "$ARCHIVE" ]; then
            echo "Error: No archive matching ${{ matrix.archive_pattern }} found"
            ls -la
            exit 1
          fi
          echo "ARCHIVE=$ARCHIVE" >> $GITHUB_OUTPUT
          echo "Found archive: $ARCHIVE"

      # Extract VST3 from the build archive
      - name: Extract VST3 (macOS/Windows)
        if: runner.os != 'Linux'
        shell: bash
        run: |
          mkdir -p extracted
          cd dist
          unzip "${{ steps.find_archive.outputs.ARCHIVE }}" -d ../extracted
          echo "=== Extracted contents ==="
          ls -la ../extracted/

      - name: Extract VST3 (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p extracted
          cd dist
          tar -xzvf "${{ steps.find_archive.outputs.ARCHIVE }}" -C ../extracted
          echo "=== Extracted contents ==="
          ls -la ../extracted/

      # Download pluginval
      - name: Download pluginval
        shell: bash
        run: |
          curl -L -o pluginval.zip ${{ matrix.pluginval_url }}
          unzip pluginval.zip -d pluginval

      # Run pluginval against extracted VST3
      - name: Run pluginval
        shell: bash
        run: |
          VST3_PATH="extracted/VST3/Boomerang+.vst3"
          echo "Validating: $VST3_PATH"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            ./pluginval/pluginval.app/Contents/MacOS/pluginval --validate "$VST3_PATH" --strictness-level 5
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            ./pluginval/pluginval.exe --validate "$VST3_PATH" --strictness-level 5
          else
            # Linux needs Xvfb for headless GUI
            sudo apt-get install -y xvfb
            xvfb-run ./pluginval/pluginval --validate "$VST3_PATH" --strictness-level 5
          fi
