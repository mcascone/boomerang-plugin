name: Build

on:
  push:
    branches: ['**']
    paths-ignore:
      - './*.md'
      - '.github/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            cmake_flags: -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
            artifact_name: boomerang-macos
          - os: windows-latest
            cmake_flags: ""
            artifact_name: boomerang-windows
          - os: ubuntu-latest
            cmake_flags: ""
            artifact_name: boomerang-linux

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0  # Full history for git version

      # Extract version from git (single source of truth)
      - name: Extract Version
        id: version
        shell: bash
        run: |
          # Use git describe for version
          # At a tag:    v2.0.0-beta-3 -> 2.0.0-beta-3
          # After a tag: v2.0.0-beta-3-5-g1234abc -> 2.0.0-beta-3+5.g1234abc
          GIT_DESCRIBE=$(git describe --tags --always)
          # Strip 'v' prefix
          VERSION="${GIT_DESCRIBE#v}"
          # Convert git format (tag-N-gHASH) to semver metadata (tag+N.gHASH)
          VERSION=$(echo "$VERSION" | sed -E 's/^(.+)-([0-9]+)-(g[0-9a-f]+)$/\1+\2.\3/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      # Linux: Install ALSA and other audio dependencies
      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libjack-jackd2-dev \
            ladspa-sdk \
            libfreetype6-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxrender-dev \
            libwebkit2gtk-4.1-dev \
            libglu1-mesa-dev \
            mesa-common-dev

      # Configure CMake
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ${{ matrix.cmake_flags }}

      # Build
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      # List build artifacts for debugging
      - name: List Artifacts
        shell: bash
        run: |
          echo "=== Build Artifacts ==="
          find build -name "*.vst3" -o -name "*.component" -o -name "*.app" -o -name "*.exe" 2>/dev/null || true
          ls -la build/Boomerang_artefacts/ || true

      # Fix code signing for macOS (resolves "sealed resource" issues)
      - name: Re-sign macOS Bundles
        if: runner.os == 'macOS'
        run: |
          echo "Re-signing bundles to fix 'sealed resource' issues..."
          BUILD_DIR="build/Boomerang_artefacts/${{ env.BUILD_TYPE }}"
          
          if [ ! -d "${BUILD_DIR}" ]; then
            echo "Error: Build directory ${BUILD_DIR} not found"
            exit 1
          fi
          
          # Remove and re-sign VST3
          if [ -d "${BUILD_DIR}/VST3/Boomerang+.vst3" ]; then
            codesign --remove-signature "${BUILD_DIR}/VST3/Boomerang+.vst3" || true
            if codesign --force --deep --sign - "${BUILD_DIR}/VST3/Boomerang+.vst3"; then
              echo "✓ VST3 re-signed"
            else
              echo "✗ VST3 signing failed"
              exit 1
            fi
          fi
          
          # Remove and re-sign AU
          if [ -d "${BUILD_DIR}/AU/Boomerang+.component" ]; then
            codesign --remove-signature "${BUILD_DIR}/AU/Boomerang+.component" || true
            if codesign --force --deep --sign - "${BUILD_DIR}/AU/Boomerang+.component"; then
              echo "✓ AU re-signed"
            else
              echo "✗ AU signing failed"
              exit 1
            fi
          fi
          
          # Remove and re-sign Standalone
          if [ -d "${BUILD_DIR}/Standalone/Boomerang+.app" ]; then
            codesign --remove-signature "${BUILD_DIR}/Standalone/Boomerang+.app" || true
            if codesign --force --deep --sign - "${BUILD_DIR}/Standalone/Boomerang+.app"; then
              echo "✓ Standalone re-signed"
            else
              echo "✗ Standalone signing failed"
              exit 1
            fi
          fi
          
          echo "Re-signing complete"

      # Package - macOS
      - name: Package macOS
        if: runner.os == 'macOS'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist
          # Create zip with all formats (artifacts are in BUILD_TYPE/ for multi-config builds)
          cd build/Boomerang_artefacts/${{ env.BUILD_TYPE }}
          cp ../../../README.md .
          zip -r ../../../dist/Boomerang-${VERSION}-macOS.zip VST3 AU Standalone README.md
          cd ../../..
          # Build the installer package
          BOOMERANG_VERSION="$VERSION" ./build-installer.sh
          cp build/installer/*.pkg dist/ 2>/dev/null || true

      # Package - Windows
      - name: Package Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist
          cd build/Boomerang_artefacts/Release
          cp ../../../README.md .
          7z a ../../../dist/Boomerang-${VERSION}-Windows.zip VST3 Standalone README.md
          cd ../../..

      # Package - Linux
      - name: Package Linux
        if: runner.os == 'Linux'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p dist
          cd build/Boomerang_artefacts/Release
          cp ../../../README.md .
          tar -czvf ../../../dist/Boomerang-${VERSION}-Linux.tar.gz VST3 Standalone README.md
          cd ../../..

      # Upload artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/*
          retention-days: 14

  # Validate plugins with pluginval (downloads artifacts from build job - no rebuild)
  validate:
    name: Validate ${{ matrix.os }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            pluginval_url: https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_macOS.zip
            artifact_name: boomerang-macos
            archive_pattern: "Boomerang-*-macOS.zip"
          - os: windows-latest
            pluginval_url: https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_Windows.zip
            artifact_name: boomerang-windows
            archive_pattern: "Boomerang-*-Windows.zip"
          - os: ubuntu-latest
            pluginval_url: https://github.com/Tracktion/pluginval/releases/latest/download/pluginval_Linux.zip
            artifact_name: boomerang-linux
            archive_pattern: "Boomerang-*-Linux.tar.gz"

    runs-on: ${{ matrix.os }}

    steps:
      # Download build artifacts (no checkout/rebuild needed)
      - name: Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: ${{ matrix.artifact_name }}
          path: dist

      # Find the archive file (name includes version)
      - name: Find Archive
        id: find_archive
        shell: bash
        run: |
          cd dist
          ARCHIVE=$(ls ${{ matrix.archive_pattern }} 2>/dev/null | head -1)
          if [ -z "$ARCHIVE" ]; then
            echo "Error: No archive matching ${{ matrix.archive_pattern }} found"
            ls -la
            exit 1
          fi
          echo "ARCHIVE=$ARCHIVE" >> $GITHUB_OUTPUT
          echo "Found archive: $ARCHIVE"

      # Extract VST3 from the build archive
      - name: Extract VST3 (macOS/Windows)
        if: runner.os != 'Linux'
        shell: bash
        run: |
          mkdir -p extracted
          cd dist
          unzip "${{ steps.find_archive.outputs.ARCHIVE }}" -d ../extracted
          echo "=== Extracted contents ==="
          ls -la ../extracted/

      - name: Extract VST3 (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p extracted
          cd dist
          tar -xzvf "${{ steps.find_archive.outputs.ARCHIVE }}" -C ../extracted
          echo "=== Extracted contents ==="
          ls -la ../extracted/

      # Download pluginval
      - name: Download pluginval
        shell: bash
        run: |
          curl -L -o pluginval.zip ${{ matrix.pluginval_url }}
          unzip pluginval.zip -d pluginval

      # Run pluginval against extracted VST3
      - name: Run pluginval
        shell: bash
        run: |
          VST3_PATH="extracted/VST3/Boomerang+.vst3"
          echo "Validating: $VST3_PATH"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            ./pluginval/pluginval.app/Contents/MacOS/pluginval --validate "$VST3_PATH" --strictness-level 5
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            ./pluginval/pluginval.exe --validate "$VST3_PATH" --strictness-level 5
          else
            # Linux needs Xvfb for headless GUI
            sudo apt-get install -y xvfb
            xvfb-run ./pluginval/pluginval --validate "$VST3_PATH" --strictness-level 5
          fi
