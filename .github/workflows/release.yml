name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v2.0.0-beta-3)'
        required: true
        type: string

jobs:
  # Find the build workflow to complete on main
  find-build:
    name: Find Build
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.find_run.outputs.run_id }}
    steps:
      - name: Get tag commit SHA
        id: get_sha
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "Processing tag: $TAG"

      - name: Find successful build run for tag
        id: find_run
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.get_sha.outputs.TAG }}';
            
            // Get the commit SHA for this tag
            const ref = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${tag}`
            });
            const tagSha = ref.data.object.sha;
            console.log(`Tag ${tag} points to SHA: ${tagSha}`);
            
            // If it's an annotated tag, we need to get the commit it points to
            let commitSha = tagSha;
            if (ref.data.object.type === 'tag') {
              const tagObj = await github.rest.git.getTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_sha: tagSha
              });
              commitSha = tagObj.data.object.sha;
              console.log(`Annotated tag points to commit: ${commitSha}`);
            }
            
            // Find workflow runs for this commit
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              head_sha: commitSha,
              status: 'success',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`No successful build found for commit ${commitSha}. Please ensure the build workflow completed successfully.`);
              return;
            }
            
            const runId = runs.data.workflow_runs[0].id;
            console.log(`Found successful build run: ${runId}`);
            core.setOutput('run_id', runId);

  release:
    name: Create Release
    needs: find-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download macOS artifacts
        uses: actions/download-artifact@v6
        with:
          name: boomerang-macos
          path: artifacts/boomerang-macos
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.find-build.outputs.run_id }}

      - name: Download Windows artifacts
        uses: actions/download-artifact@v6
        with:
          name: boomerang-windows
          path: artifacts/boomerang-windows
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.find-build.outputs.run_id }}

      - name: Download Linux artifacts
        uses: actions/download-artifact@v6
        with:
          name: boomerang-linux
          path: artifacts/boomerang-linux
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.find-build.outputs.run_id }}

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Get release tag
        id: get_tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "TAG=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.TAG }}
          files: |
            artifacts/boomerang-macos/*
            artifacts/boomerang-windows/*
            artifacts/boomerang-linux/*
          generate_release_notes: true
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Show In Summary
        env:
          RELEASE_URL: ${{ steps.create_release.outputs.url }}
          RELEASE_TAG: ${{ steps.get_tag.outputs.TAG }}
        run: |
          {
            echo "## Release Created"
            echo ""
            echo "- Release tag: $RELEASE_TAG"
            echo "- [Release Link]($RELEASE_URL)"
          } >> $GITHUB_STEP_SUMMARY

