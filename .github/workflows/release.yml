name: Release

on:
  # Trigger on tag push - will find existing build for that commit
  push:
    tags: ['v*']
  # Manual trigger for re-releasing or releasing a specific tag
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v2.0.0-beta-3)'
        required: true
        type: string

jobs:
  # Find the existing successful build for this tag's commit
  find-build:
    name: Find Build
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.find.outputs.run_id }}
      tag: ${{ steps.find.outputs.tag }}
    steps:
      - name: Find successful build for tag
        id: find
        uses: actions/github-script@v7
        with:
          script: |
            // Determine the tag
            let tag;
            if (context.eventName === 'workflow_dispatch') {
              tag = '${{ github.event.inputs.tag }}';
            } else {
              tag = context.ref.replace('refs/tags/', '');
            }
            console.log(`Looking for build for tag: ${tag}`);
            
            // Get the commit SHA for this tag
            const ref = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${tag}`
            });
            let commitSha = ref.data.object.sha;
            console.log(`Tag points to: ${commitSha}`);
            
            // If annotated tag, get the underlying commit
            if (ref.data.object.type === 'tag') {
              const tagObj = await github.rest.git.getTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_sha: commitSha
              });
              commitSha = tagObj.data.object.sha;
              console.log(`Annotated tag points to commit: ${commitSha}`);
            }
            
            // Find successful build for this commit
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              head_sha: commitSha,
              status: 'success',
              per_page: 1
            });
            
            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`No successful build found for commit ${commitSha}. Push to main first and wait for build to complete before tagging.`);
              return;
            }
            
            const runId = runs.data.workflow_runs[0].id;
            console.log(`Found successful build run: ${runId}`);
            core.setOutput('run_id', runId);
            core.setOutput('tag', tag);

  release:
    name: Create Release
    needs: find-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download macOS artifacts
        uses: actions/download-artifact@v6
        with:
          name: boomerang-macos
          path: artifacts/boomerang-macos
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.find-build.outputs.run_id }}

      - name: Download Windows artifacts
        uses: actions/download-artifact@v6
        with:
          name: boomerang-windows
          path: artifacts/boomerang-windows
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.find-build.outputs.run_id }}

      - name: Download Linux artifacts
        uses: actions/download-artifact@v6
        with:
          name: boomerang-linux
          path: artifacts/boomerang-linux
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ needs.find-build.outputs.run_id }}

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.find-build.outputs.tag }}
          files: |
            artifacts/boomerang-macos/*
            artifacts/boomerang-windows/*
            artifacts/boomerang-linux/*
          generate_release_notes: true
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Show In Summary
        env:
          RELEASE_URL: ${{ steps.create_release.outputs.url }}
          RELEASE_TAG: ${{ needs.find-build.outputs.tag }}
        run: |
          {
            echo "## Release Created"
            echo ""
            echo "- Release tag: $RELEASE_TAG"
            echo "- [Release Link]($RELEASE_URL)"
          } >> $GITHUB_STEP_SUMMARY
          } >> $GITHUB_STEP_SUMMARY

